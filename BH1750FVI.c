#include <BH1750FVI.h>
#include "delay.h"

#define SlaveAddress 0x46 //??????????IIC?????��????,????ALT  ADDRESS????????????
                              //ALT  ADDRESS???????????0x46???????????0xB8

unsigned char BUF[8];                         //?????????????      	
int dis_data;                       //????

sbit SCL = P4^0;      //IIC??????????
sbit SDA = P4^7;      //IIC???????????

//void Init_BH1750(void);

void BH1750_Start()
{
    SDA = 1;                    //??????????
    SCL = 1;                    //?????????
    delay5us();                 //???
    SDA = 0;                    //?????????
    delay5us();                 //???
    SCL = 0;                    //?????????
}

/**************************************
?????
**************************************/
void BH1750_Stop()
{
    SDA = 0;                    //??????????
    SCL = 1;                    //?????????
    delay5us();                 //???
    SDA = 1;                    //??????????
    delay5us();                 //???
}

/**************************************
??????????
??????:ack (0:ACK 1:NAK)
**************************************/
void BH1750_SendACK(bit ack)
{
    SDA = ack;                  //��??????
    SCL = 1;                    //?????????
    delay5us();                 //???
    SCL = 0;                    //?????????
    delay5us();                 //???
}

/**************************************
??????????
**************************************/
bit BH1750_RecvACK()
{
    SCL = 1;                    //?????????
    delay5us();                 //???
    CY = SDA;                   //????????
    SCL = 0;                    //?????????
    delay5us();                 //???

    return CY;
}

/**************************************
??IIC?????????????????
**************************************/
void BH1750_SendByte(u8 dat)
{
    u8 i;

    for (i=0; i<8; i++)         //8��??????
    {
        dat <<= 1;              //???????????��
        SDA = CY;               //???????
        SCL = 1;                //?????????
        delay5us();             //???
        SCL = 0;                //?????????
        delay5us();             //???
    }
    BH1750_RecvACK();
}

/**************************************
??IIC?????????????????
**************************************/
u8 BH1750_RecvByte()
{
    u8 i;
    u8 dat = 0;

    SDA = 1;                    //??????????,??????????,
    for (i=0; i<8; i++)         //8��??????
    {
        dat <<= 1;
        SCL = 1;                //?????????
        delay5us();             //???
        dat |= SDA;             //??????               
        SCL = 0;                //?????????
        delay5us();             //???
    }
    return dat;
}

//*********************************

void Single_Write_BH1750(u8 REG_Address)
{
    BH1750_Start();                  //??????
    BH1750_SendByte(SlaveAddress);   //?????��???+��???
    BH1750_SendByte(REG_Address);    //?????????????
    BH1750_Stop();                   //?????????
}



//*********************************************************
//
//????????BH1750???????
//
//*********************************************************
void Multiple_read_BH1750(void)
{   
    u8 i;	
    BH1750_Start();                          //??????
    BH1750_SendByte(SlaveAddress+1);         //?????��???+?????
	
	 for (i=0; i<3; i++)                      //???????2???????????��??BUF
    {
        BUF[i] = BH1750_RecvByte();          //BUF[0]?��0x32????��?????
        if (i == 3)
        {

           BH1750_SendACK(1);                //???????????????NOACK
        }
        else
        {		
          BH1750_SendACK(0);                //???ACK
        }
    }

    BH1750_Stop();                          //?????
    delay5ms();
}


//?????BH1750???????????��?pdf???????****
//void Init_BH1750()
//{
//   Single_Write_BH1750(0x01);  

//}
//*********************************************************
//??????********
//*********************************************************
u16 Receive_Data()
{  
    u16 temp;
    Single_Write_BH1750(0x01);   // power on
    Single_Write_BH1750(0x10);   // H- resolution mode

    delay180ms();              //???180ms

    Multiple_Read_BH1750();       //??????????????��??BUF??

    dis_data=BUF[0];
    dis_data=(dis_data<<8)+BUF[1];//??????????????????
    
    temp=(float)dis_data/1.2;
    return temp;

}